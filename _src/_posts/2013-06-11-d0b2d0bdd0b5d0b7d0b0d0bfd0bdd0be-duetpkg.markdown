---
author: wrfsh
comments: true
date: 2013-06-11 14:40:04+00:00
layout: post
slug: '%d0%b2%d0%bd%d0%b5%d0%b7%d0%b0%d0%bf%d0%bd%d0%be-duetpkg'
title: Внезапно DuetPkg
wordpress_id: 100
tags:
- BIOS
- UEFI
---

После одного часа, потраченного на DuetPkg из EDK2 удалось его собрать и прожечь на загрузочную флешку. Загрузившись на реальной машине через BIOS внезапно оказалось, что в получившейся среде есть:



	
  * Печать юникода на экран (у среды есть французская локализация).

	
  * Полноценный UEFI рантайм, поверх которого успешно грузятся драйвера и запускатся приложения, в том числе и шелл.

	
  * PCI/USB стек.

	
  * Sata, Scsi, Ide драйвера, которые можно подгружать

	
  * Готовые механизмы возврата в реальный режим и вызова BIOS ISR.

	
  * Много еще чего-то, чего я не успел заметить


Не удалось проверить клавиатурные раскладки. В остальном, внезапно, DuetPkg дает все выше перечисленное, т.е. снимает где-то пол года работы по воссозданию среды эмуляции UEFI. Чтобы заработали токены надо портировать libopensc. USB стек уже есть.

Конечно скорее всего это не бесплатно. При таком богатстве наверное опять встанет проблема состояния железа. Но в этом случае она несравнимо более контролируемая чем  на Linux и, к примеру, написать дисковый драйвер для этой среды, опирающийся на int 13h, не составит особого труда. Более контролируемая она потому что получившаяся среда крайне модульная, очень недалеко стоит от BIOS'а и по своему объему вполне доступна для понимания одним человеком. Выкинуть из сборки например поддержку AHCI будет очень просто. Реализовать замену через int 13h тоже несложно.

Я только очень надеюсь что вопрос с лицензированием не подведет. В остальном таким образом относительно легко BIOS уравнивается в функционале до UEFI, точнее того его подмножества, который мне нужен. Нужно работать дальше, но пока этот вариант выглядит очень привлекательно.

Мне кажется, что при таком раскладе на первый план сейчас выходит проработка загрузки хостовой ОС из этой среды через оригинальный MBR. И тут я припас главное. Есть open source проект [Clover](http://sourceforge.net/projects/cloverefiboot/), который представляет из себя UEFI-based boot loader, основанный на DuetPkg, стартующий с BIOS и загружающий ряд операционных систем. Т.е. он решает эту задачу и им можно вдохновлятся. Ну к примеру реализация вышеупомянутого BlockIo драйвера через INT 13h: [http://sourceforge.net/p/cloverefiboot/code/HEAD/tree/LegacyBios/BlockIoDxe/](http://sourceforge.net/p/cloverefiboot/code/HEAD/tree/LegacyBios/BlockIoDxe/)

Все это внезапно выглядит слишком хорошо.

UPD: Лицензия - [http://edk2.svn.sourceforge.net/viewvc/edk2/trunk/edk2/MdeModulePkg/License.txt?revision=14397&view=markup](http://edk2.svn.sourceforge.net/viewvc/edk2/trunk/edk2/MdeModulePkg/License.txt?revision=14397&view=markup)  
Насколько я понимаю она позволяет нам использовать этот код без ограничений кроме как приложить текст дисклеймера?
