---
author: wrfsh
comments: true
date: 2014-06-06 04:26:19+00:00
layout: post
slug: linux-on-efi-wo-reboot
title: Possible solution to Linux on EFI w/o reboot
wordpress_id: 394
tags:
- crazy ideas
---

Как можно реализовать линукс без перезагрузки на EFI:



	
  1. При передаче управления из EFI в Linux нужно проделать ряд операций:

	
    1. Позвать DisconnectController чтобы отключить все драйвера периферийных устройств (ввод/вывод, сеть, диск, USB)

	
    2. Получить актуальную карту памяти EFI и сохранить как ее, так и саму память, занятую EFI. По возможности сдампить ее на диск

	
    3. Отключить прерывания, сохранить адрес IDT фирмвари и настройки контроллера прерываний.

	
    4. Сохранить весь контекст выполнения (сегменты, регистры, адрес стека, etc.), примерно тоже самое что и setjmp/makecontext




	
  2. Запустить ядро, юзермодный аппликейшен.

	
  3. Позвать kexec чтобы выполнить код в защищенном режиме который:

	
    1. Восстанавливает карту памяти и память фирмвари сохраненную в пункте 1.b.

	
    2. Восстановить IDT фирмвари и настройки контроллера прерываний сохраненные в пункте 1.c.

	
    3. Восстановить контекст выполнения из пункта 1.d. (по сути сделать longjmp/setcontext), включить прерывания.

	
    4. Позвать ConnectController для подключения драйверов к периферийным устройствам.





Суть подхода в том, чтобы рассматривать контекст выполнения фирмвари как выгружаемую задачу, сохранить и выгрузить ее, а затем восстановить обратно. Теоретически можно даже модифицировать планировщик задач ядра так чтобы он часть грязной работы сделал сам. DisconnectController / ConnectController в теории позволяет решить проблему с состоянием железа после возврата из ядра, т.к. ConnectController должен заново запустить инициализацию драйверов фирмвари, которые должны привести свои девайсы в известное состояние.

Весь подход держится на поведении ConnectController и драйверов фирмвари. Если они не следуют EFI Driver Binding модели, что теоретически возможно, то переинициализация устройств будет затруднительной. Как показала практика, в реальности опасно опираться на соответствие фирмвари чему-то из советов UEFI спецификации.
