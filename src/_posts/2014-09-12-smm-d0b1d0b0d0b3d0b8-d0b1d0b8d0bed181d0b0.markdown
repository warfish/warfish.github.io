---
author: wrfsh
comments: true
date: 2014-09-12 03:59:05+00:00
layout: post
slug: smm-%d0%b1%d0%b0%d0%b3%d0%b8-%d0%b1%d0%b8%d0%be%d1%81%d0%b0
title: SMM баги биоса
wordpress_id: 406
---

Есть подозрение на аппаратный/SMM баг USB Legacy Support на Dell Optiplex 790.

Имеем данную машину и подключенные к ней USB клаву и мышь, которые работают через виртуальный 8042 PS/2 контроллер через USB Legacy Support. Биос настраивает виртуальный 8042 так, что сканирование KBD порта разрешено, а сканирование AUX порта отключено. Хучим в риалмодной IDT IRQ1 (PS/2 KBD port interrupt) и IRQ12 (PS/2 AUX port interrupt) исключая код биоса. Хук IRQ1 предсказуемо срабатывает на клавиатурные события, а хук IRQ12 предсказуемо молчит на мышиные события. Затем включаем на контроллере сканирование AUX порта. Сразу после этого контроллер перестает триггерить _все_ IRQ, нет событий ни от клавы ни от мыши. Все из реального режима.

Замена IRQ хендлеров в IDT исключает ring0 код биоса. Код включения сканирования порта крайне простой и работает на всех остальных конфигурациях. Остается только SMM код биоса (USB Legacy Support генерирует SMI) и аппаратную реализацию. __

Решить эту проблему нельзя, ее можно только обойти. Для этого нужно сначала отключить USB legacy support, а затем инициализировать PS/2 драйвера уже для настоящего контроллера. Отключение legacy support на EHCI происходит через машину состояний:



	
  1. В определенном регистре контроллера OS выставляет бит "я хочу контроллер".

	
  2. Срабатывает SMM прерывание в котором биос должен подготовить контроллер к передаче и сбросить другой бит "биос отдал контроллер". Как только этот бит выставлен процесс передачи контроллера можно считать законченным.


На этой машине сидят два EHCI контроллера. Один из них успешно прошел этот процесс, а второй отказывается сбрасывать бит владения биосом. При этом видно, что SMM прерывания с него перестали работать, т.е. биос его реально отдал. Эту проблему решил уже апдейт биоса :)
