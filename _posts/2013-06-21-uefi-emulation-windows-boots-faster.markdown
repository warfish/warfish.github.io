---
author: wrfsh
comments: true
date: 2013-06-21 15:49:11+00:00
layout: post
slug: uefi-emulation-windows-boots-faster
title: '[UEFI Emulation] Windows boots (faster)'
wordpress_id: 164
tags:
- BIOS
- preboot
- UEFI
---

Пребут на базе EDK/Duet загружается и с обычной скоростью загружает NT на 5 (из 5) тестовых реальных машинах. Какие проблемы были решены за эту неделю:



	
  1. Пожалуй основная проблема в том, что биосы стали очень умные. Многие стартуют сразу с включенным A20. Некоторые используют пейджинг, работая внутри ISR в защищенном режиме. Из-за этого восстанавливать нужно такие вещи как GDTR, CR0-4, состояние A20.

	
  2. Проблема с замедлением загрузки NT была связана с тем, что биос, находясь в реальном режиме, считает тики таймера, прошедшие с момента загрузки. После ухода в EDK биос больше не видит прерываний таймера и тики начинают теряться. Если по возврату из EDK правильно посчитать сколько тиков прошло с момента загрузки и прописать это значение для биоса, то все грузится с обычной скоростью. Конкретный код, который завязан на значения тиков выяснить не удалось (нет дебаггера). Была придумана теория и проверена вслепую.

	
  3. В DuetPkg есть баг, из-за которого происходит коррапт памяти ниже первого мегабайта: [http://sourceforge.net/p/tianocore/edk2/ci/master/tree/DuetPkg/DxeIpl/HobGeneration.h#l26](http://sourceforge.net/p/tianocore/edk2/ci/master/tree/DuetPkg/DxeIpl/HobGeneration.h#l26). Код по ссылке готовит для DxeCore (ядро EDK) т.н. HOB - HandOff Block. В этом блоке загрузчик прописывает таблицы страниц физической памяти, свободные на момент передачи управления из стадии DxeIpl в стадию DxeCore. К сожалению, авторы DxeIpl в дуэте решили захардкодить верхнюю границу диапазона доступной памяти ниже 1MB значением в 0x9F800, что соответствует 640 KB. Практически все современные биосы оставляют меньше свободной памяти, в районе 600KB. В результате при маппировании страниц ниже 1MB перетирается код биоса.


Проблемы выше были исправлены и теперь все снова хорошо. Танцевать еще рано, но пританцовывать можно начинать.
