---
author: wrfsh
comments: true
date: 2013-10-06 04:24:05+00:00
layout: post
slug: doom-uefi-wad-files-and-edk-stdlib-problems
title: '[DOOM-UEFI] WAD files and EDK stdlib problems'
wordpress_id: 243
tags:
- doom-uefi
---

Дум хранит все свои ресурсы в одном файле с расширением wad. Структура очень простая:

Заголовок файла описывается структурой wadinfo_t:


<blockquote>struct wadinfo_t
{
char id[4]; // "IWAD" or "PWAD"
int numlumps;
int tableoffset;
};</blockquote>


Файла начинается с "IWAD" или "PWAD" идентификатора, tableoffset показывает на позицию в файле где хранится массив структур filelump_t размером numlumps элементов:


<blockquote>struct filelump_t
{
char name[8];
int size;
int filepos;
};</blockquote>


filelump_t показывает на область файла filepos, где хранится бинарный блоб с именем name и размером size байт. В doom.wad около 2 тысяч таких лампов. Каждый ламп хранится бинарным блобом с какой-то своей структурой, про которую wad файл ничего не знает.

Стартуя, дум пытается найти несколько wad файлов по известным именам и определяет тип игры по имени найденного wad файла: doom.wad для doom1, doomu.wad для unltimate doom, doom2.wad для doom2, etc. Чтобы понять существует файл или нет код использует посиксовую функцию access(2), которая возвращает 0 если файл существует и доступен на открытие с запрошенными правами либо ошибку.

Тут начинаются проблемы с EDK stdlib. Их реализация access возвращает 0 даже если файла нет, т.е. для нее все файлы существуют. Она опирается на функцию open, которая тоже всегда возвращает ненулевой дескриптор даже если файла нет, потому что в реализации баг, который как бы по умолчанию подразумевает флаг O_CREATE, т.е. создать файл если его нет.

Чинить open я не хочу, иначе мой бранч на гитхабе не будет работать у людей со свежим EDK. Переписывать open тяжело, но возможно придется. Пока я просто поставил поиск doom.wad первым в списке, потому что он как раз и должен быть найден.

P.S.: Структуры взяты из самого кода дума. Используются типы не фиксированного размера, что создало проблемы на X64, что правда легко исправить.
